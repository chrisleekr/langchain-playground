# Parent pipeline that reads Node.js and npm versions from source files
# and triggers child pipeline with dynamic version variables.
# This enables using .nvmrc as single source of truth for Node.js version.

stages:
  - prepare
  - trigger

# Read versions from .nvmrc and package.json, pass to child pipeline
read-versions:
  stage: prepare
  image: alpine:3.21
  script:
    - apk add --no-cache nodejs
    - NODE_VERSION=$(cat .nvmrc | tr -d '[:space:]')
    - NPM_VERSION=$(node -p "require('./package.json').volta.npm")
    - echo "NODE_VERSION=$NODE_VERSION" >> versions.env
    - echo "NPM_VERSION=$NPM_VERSION" >> versions.env
    - echo "Detected versions:"
    - cat versions.env
  artifacts:
    reports:
      dotenv: versions.env

# Trigger the main pipeline with version variables
run-pipeline:
  stage: trigger
  needs:
    - read-versions
  trigger:
    include: .gitlab-ci-jobs.yml
    strategy: depend
  variables:
    NODE_VERSION: $NODE_VERSION
    NPM_VERSION: $NPM_VERSION
